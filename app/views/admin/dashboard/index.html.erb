<% content_for :admin_breadcrumb do %>
  <span>Dashboard</span>
<% end %>

<div>
  <h1 class="h3 mb-4">Dashboard</h1>
  <div class="row g-4">
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total Users</div>
          <div class="h4 m-0"><%= @total_users %></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Active Users</div>
          <div class="h4 m-0"><%= @active_users %></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">New Users (7d)</div>
          <div class="h4 m-0"><%= @new_users_7d %></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Posts (7d)</div>
          <div class="h4 m-0"><%= @posts_7d %></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Users over time</span>
          <%= form_with url: admin_dashboard_path, method: :get, local: true, class: "d-flex align-items-center gap-2" do %>
            <input type="date" class="form-control" name="start_date" value="<%= @start_date %>">
            <input type="date" class="form-control" name="end_date" value="<%= @end_date %>">
            <button class="btn btn-sm btn-outline-primary" type="submit">Apply</button>
          <% end %>
        </div>
        <div class="card-body">
          <canvas id="usersByDayChart" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header">Profiles by Type</div>
        <div class="card-body">
          <canvas id="profilesByTypeChart" height="200"></canvas>
        </div>
      </div>
      <div class="card shadow-sm">
        <div class="card-header">Top Sports by Posts</div>
        <div class="card-body">
          <canvas id="topSportsChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-lg-12">
      <div class="card shadow-sm">
        <div class="card-header">Posts last 7 days</div>
        <div class="card-body">
          <canvas id="postsByDayChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :head do %>
  <script type="module">
    import Chart from "chart.js";

    const usersByDayLabels = <%= raw @users_by_day.map { |d,c| d.strftime('%b %d') }.to_json %>;
    const usersByDayData = <%= raw @users_by_day.map { |d,c| c }.to_json %>;

    const postsByDayLabels = <%= raw @posts_by_day.map { |d,c| d.strftime('%b %d') }.to_json %>;
    const postsByDayData = <%= raw @posts_by_day.map { |d,c| c }.to_json %>;

    const profilesByTypeLabels = <%= raw @profiles_by_type.keys.to_json %>;
    const profilesByTypeData = <%= raw @profiles_by_type.values.to_json %>;

    const topSportsLabels = <%= raw @top_sports.keys.to_json %>;
    const topSportsData = <%= raw @top_sports.values.to_json %>;

    new Chart(document.getElementById('usersByDayChart'), {
      type: 'line',
      data: { labels: usersByDayLabels, datasets: [{ label: 'Users', data: usersByDayData, borderColor: '#0d6efd', fill: false }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    new Chart(document.getElementById('postsByDayChart'), {
      type: 'bar',
      data: { labels: postsByDayLabels, datasets: [{ label: 'Posts', data: postsByDayData, backgroundColor: '#198754' }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    new Chart(document.getElementById('profilesByTypeChart'), {
      type: 'doughnut',
      data: { labels: profilesByTypeLabels, datasets: [{ data: profilesByTypeData }] },
      options: { responsive: true }
    });

    new Chart(document.getElementById('topSportsChart'), {
      type: 'pie',
      data: { labels: topSportsLabels, datasets: [{ data: topSportsData }] },
      options: { responsive: true }
    });
  </script>
<% end %>


